<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Sheets Data Entry Platform</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-header {
      background: #0f172a;
      color: #e5e7eb;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(15,23,42,0.25);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .app-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .app-header-sub {
      font-size: 12px;
      color: #9ca3af;
    }

    .app-header-right {
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
    }

    .app-body {
      flex: 1;
      display: flex;
      flex-direction: row; /* sidebar on the LEFT */
      min-height: calc(100vh - 52px);
    }

    /* Sidebar */

    .sidebar {
      width: 280px;
      background: #020617;
      color: #e5e7eb;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-right: 1px solid #111827;
    }

    .sidebar-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .sheets-count {
      font-size: 11px;
      color: #9ca3af;
    }

    .sidebar-search {
      width: 100%;
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid #1e293b;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }

    .sidebar-search::placeholder {
      color: #6b7280;
    }

    .sheet-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0 0;
      max-height: 50vh;
      overflow-y: auto;
    }

    .sheet-list li {
      margin-bottom: 6px;
    }

    .sheet-btn {
      width: 100%;
      border: none;
      padding: 8px 10px;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      text-align: left;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      border: 1px solid transparent;
      transition: background 0.15s, transform 0.1s, border-color 0.15s;
    }

    .sheet-btn span.name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sheet-btn span.fields-count {
      font-size: 10px;
      color: #9ca3af;
    }

    .sheet-btn:hover {
      background: #0b1120;
      border-color: #1e293b;
      transform: translateY(-1px);
    }

    .sheet-btn.active {
      background: #0ea5e9;
      color: #0b1120;
      border-color: #38bdf8;
      font-weight: 600;
    }

    .json-controls {
      border-top: 1px solid #111827;
      padding-top: 10px;
      margin-top: 4px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .btn,
    .file-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      border-radius: 999px;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      text-decoration: none;
    }

    .btn-primary {
      background: #10b981;
      color: #022c22;
    }

    .btn-primary:hover {
      background: #34d399;
    }

    .file-label {
      background: #e5e7eb;
      color: #111827;
      position: relative;
      overflow: hidden;
    }

    .file-label:hover {
      background: #d1d5db;
    }

    .file-label input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .json-hint {
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.4;
    }

    /* Main area */

    .main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .main-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 18px 20px;
      box-shadow: 0 10px 24px rgba(15,23,42,0.08);
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-height: calc(100vh - 64px);
    }

    .main-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
    }

    .main-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .main-header-title {
      font-size: 18px;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .main-header-sub {
      font-size: 12px;
      color: #6b7280;
    }

    .main-header-right {
      text-align: right;
      font-size: 11px;
      color: #6b7280;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 11px;
      font-weight: 500;
      margin-left: 4px;
    }

    .tag-ghost {
      background: #f9fafb;
      color: #4b5563;
    }

    /* Form area */

    .form-header-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .form-title {
      font-size: 14px;
      font-weight: 500;
    }

    .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 10px 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    label {
      font-weight: 500;
      color: #374151;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"] {
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    input:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 1px rgba(14,165,233,0.3);
    }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
      font-size: 12px;
    }

    #message {
      min-height: 18px;
    }

    #message.success {
      color: #059669;
    }

    #message.error {
      color: #b91c1c;
    }

    .edit-indicator {
      font-size: 11px;
      color: #b45309;
      background: #fffbeb;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #facc15;
    }

    /* Table area */

    .table-header-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .row-stats {
      font-size: 11px;
      color: #6b7280;
    }

    .table-search-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .table-search {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      min-width: 180px;
    }

    .page-size-select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }

    .table-wrapper {
      margin-top: 6px;
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      max-height: calc(100vh - 320px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 650px;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    tr:hover td {
      background: #eef2ff;
    }

    .no-data {
      font-size: 12px;
      color: #9ca3af;
      padding: 10px 0 2px;
    }

    .table-actions {
      display: flex;
      gap: 4px;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .table-btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      padding: 3px 8px;
    }

    .table-btn-edit {
      background: #e0f2fe;
      color: #0369a1;
    }

    .table-btn-edit:hover {
      background: #bae6fd;
    }

    .table-btn-delete {
      background: #fee2e2;
      color: #b91c1c;
    }

    .table-btn-delete:hover {
      background: #fecaca;
    }

    /* Pagination */

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
      flex-wrap: wrap;
      gap: 6px;
    }

    .pagination-controls {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pagination-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      padding: 3px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #e5e7eb;
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    @media (max-width: 900px) {
      .app-body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #111827;
      }
      .main-card {
        min-height: auto;
      }
      .table-wrapper {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div>
        <div class="app-header-title">Sheets Data Entry Platform</div>
        <div class="app-header-sub">
          Multi-sheet data entry, edit, search, pagination, and JSON import/export
        </div>
      </div>
      <div class="app-header-right">
        <div>Data is also saved locally in your browser (localStorage).</div>
        <div>Use JSON export/import for full Excel backup and restore.</div>
      </div>
    </header>

    <div class="app-body">
      <!-- Sidebar on the LEFT -->
      <aside class="sidebar">
        <div>
          <div class="sidebar-section-title">
            <span>Sheets</span>
            <span class="sheets-count" id="sheetsCount"></span>
          </div>
          <input
            id="sheetSearch"
            class="sidebar-search"
            type="text"
            placeholder="Search sheets..."
          />
          <ul id="sheetList" class="sheet-list"></ul>
        </div>

        <div class="json-controls">
          <div class="sidebar-section-title">
            <span>JSON Backup</span>
          </div>
          <button id="exportJsonBtn" class="btn btn-primary" type="button">
            Export all sheets as JSON
          </button>
          <label class="file-label">
            Import from JSON
            <input type="file" id="importJsonInput" accept="application/json">
          </label>
          <div class="json-hint">
            Export creates a <b>sheets-data.json</b> file containing all sheets.<br/>
            Import will merge data for sheets that exist in this app.
          </div>
        </div>
      </aside>

      <!-- Main area on the right -->
      <main class="main">
        <section class="main-card">
          <div class="main-header">
            <div class="main-header-left">
              <h2 id="sheetTitle" class="main-header-title">
                Select a sheet from the left sidebar
              </h2>
              <div id="sheetSubtitle" class="main-header-sub">
                Sheet fields and names are automatically generated from your Excel file.
              </div>
            </div>
            <div class="main-header-right">
              <div>
                <span class="tag tag-ghost">
                  <span id="fieldsCountTag">0 fields</span>
                </span>
                <span class="tag tag-ghost">
                  <span id="rowsCountTag">0 rows</span>
                </span>
              </div>
              <div>Use the form below to add or edit rows.</div>
            </div>
          </div>

          <div class="form-header-row">
            <div class="form-title">Row data</div>
            <div class="form-actions">
              <button id="saveRowBtn" class="btn btn-primary" type="button">
                Save row
              </button>
              <button id="clearFormBtn" class="btn btn-secondary" type="button">
                Clear form
              </button>
              <button id="cancelEditBtn" class="btn btn-secondary" type="button" style="display:none;">
                Cancel edit
              </button>
            </div>
          </div>

          <form id="dataForm"></form>

          <div class="status-row">
            <div id="message"></div>
            <div id="editIndicator" class="edit-indicator" style="display:none;"></div>
          </div>

          <div class="table-header-row">
            <div class="row-stats" id="rowStats"></div>
            <div class="table-search-group">
              <input
                id="rowSearch"
                class="table-search"
                type="text"
                placeholder="Search rows in this sheet..."
              />
              <select id="pageSizeSelect" class="page-size-select">
                <option value="25">25 rows / page</option>
                <option value="50" selected>50 rows / page</option>
                <option value="100">100 rows / page</option>
              </select>
            </div>
          </div>

          <div class="table-wrapper">
            <table id="dataTable"></table>
          </div>
          <div id="noDataMsg" class="no-data"></div>

          <div id="pagination" class="pagination"></div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // Sheets configuration based on your Excel file
    const sheetsConfig = {
      "QC Sequence Number": [
        "SR NO.",
        "DATE",
        "QC SEQUENCE NUMBER",
        "PO NUMBER",
        "MATERIAL DOCUMENT NUMBER",
        "LOCATED BY",
        "REMARK"
      ],

      "MIV Sequence Number": [
        "SR NO.",
        "DATE",
        "MIV SEQUENCE NUMBER",
        "RESERVATION NUMBER",
        "MATERIAL DOCUMENT NUMBER",
        "ISSUED BY",
        "REMARK"
      ],

      "Urgent book report": [
        "SR NO.",
        "UB SR NO.",
        "DATE",
        "ITEM CODE",
        "MATERIAL DESCRIPTION",
        "UOM",
        "QTY",
        "Unit Value (USD)",
        "Total Value (USD)",
        "RESRVATION NO",
        "WO NO.",
        "MATERIAL DOCUMENT NUMBER",
        "ISSUD TO",
        "DEPARTMENT",
        "STATUS",
        "ISSUE DESCRIPTION",
        "COMITTMENT ITEM",
        "REMARKS"
      ],

      "MRV Sequence Number": [
        "SR NO.",
        "DATE",
        "MRV SEQUENCE NUMBER",
        "RETURNED BY",
        "MATERIAL DOCUMENT NUMBER",
        "LOCATED BY",
        "REMARK"
      ],

      "SES Sequence Number": [
        "SR NO.",
        "DATE",
        "INVOICE NUMBER",
        "SES SEQUENCE NUMBER",
        "PO NUMBER",
        "ISSUED TO",
        "REMARKS"
      ],

      "OSDR Sequence Number": [
        "SR NO.",
        "DATE",
        "OSDR SEQUENCE NUMBER",
        "OSDR TYPE",
        "PR NUMBER",
        "PO NUMBER",
        "INVOICE / P.L.NO",
        "ITEM CODE",
        "ITEM DESCRIPTION",
        "QTY",
        "UNIT PRICE",
        "TOTAL PRICE",
        "BUYER",
        "VENDOR / SUPPLIER",
        "PROBLEM DESCRIPTION",
        "ACTION / STATUS",
        "Overseas /Local",
        "Location",
        "REMARKS",
        "STATUS"
      ],

      "Supply Chain Department": [
        "No.",
        "Badge #",
        "Name",
        "Designation",
        "Department / Sponsoring Department",
        "Company",
        "Department",
        "Vac 1",
        "Date1",
        "Vac 2",
        "Date 2",
        "Vaccine Center",
        "Booster Due",
        "Booster Due Date",
        "Booster",
        "Booster Vac date",
        "Place of Residence",
        "Nationality",
        "Contract Type",
        "STAYING IN CAMP",
        "ON / OFF",
        "LN / E",
        "Remark"
      ],

      "PR Sequence Number": [
        "SR NO.",
        "DATE",
        "MRF SEQUENCE NUMBER",
        "INVOICE NUMBER",
        "PR NUMBER",
        "ISSUED TO",
        "LOCAL / OVERSEAS",
        "REMARKS"
      ],

      "GATE PASS-POD": [
        "SR NO.",
        "DATE",
        "GATE PASS NO.",
        "ITEM CODE",
        "SERIAL NUMBER",
        "ITEM DESCRIPTION",
        "UNIT",
        "QTY",
        "CONSIGNEE",
        "INV / POD REF. NO",
        "WORK ORDER",
        "PR NUMBER",
        "SENT",
        "DELIVERED TO KM",
        "REMARKS"
      ],

      "EQUIPMENT CERTIFICATE": [
        "NO.",
        "EQUIPMENT DESCRIPTION",
        "QTY",
        "LOCATION",
        "CERTI NO",
        "VENDOR",
        "TEST DATE",
        "EXPIRY DATE",
        "STATUS",
        "VARIANCE IN DAYS",
        "REMARKS"
      ],

      "KM Shipping Invoice": [
        "Sr No.",
        "Date",
        "Invoice / P.L.No:",
        "PR Nos.",
        "Item Description",
        "QTY",
        "Delivery Address / Destination",
        "Country",
        "Status",
        "Remarks"
      ],

      "INVOICE TRACKING REPORT": [
        "SR NO.",
        "INVOICE NUMBER",
        "PR NUMBER",
        "PONUMBER",
        "SUPPLIER",
        "IAAR / WO REF. NO.",
        "RECEIPT DATE",
        "REQUESTED BY",
        "DEPARTMENT",
        "LOCAL / OVERSEAS",
        "INSPECTED BY END-USER",
        "REMARKS"
      ]
    };

    // In-memory data store: sheet name -> array of row objects
    const dataStore = {};
    Object.keys(sheetsConfig).forEach(name => {
      dataStore[name] = [];
    });

    const LOCAL_STORAGE_KEY = "sheetsDataStore_v1";

    let currentSheet = null;
    let editIndex = null;
    let rowSearchQuery = "";
    let sheetSearchQuery = "";
    let currentPage = 1;
    let pageSize = 50;

    // DOM references
    const sheetListEl = document.getElementById("sheetList");
    const sheetsCountEl = document.getElementById("sheetsCount");
    const sheetSearchEl = document.getElementById("sheetSearch");

    const sheetTitleEl = document.getElementById("sheetTitle");
    const sheetSubtitleEl = document.getElementById("sheetSubtitle");
    const fieldsCountTagEl = document.getElementById("fieldsCountTag");
    const rowsCountTagEl = document.getElementById("rowsCountTag");
    const rowStatsEl = document.getElementById("rowStats");

    const formEl = document.getElementById("dataForm");
    const saveRowBtn = document.getElementById("saveRowBtn");
    const clearFormBtn = document.getElementById("clearFormBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const messageEl = document.getElementById("message");
    const editIndicatorEl = document.getElementById("editIndicator");

    const tableEl = document.getElementById("dataTable");
    const noDataMsgEl = document.getElementById("noDataMsg");
    const rowSearchEl = document.getElementById("rowSearch");
    const pageSizeSelectEl = document.getElementById("pageSizeSelect");
    const paginationEl = document.getElementById("pagination");

    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const importJsonInput = document.getElementById("importJsonInput");

    function guessInputType(fieldName) {
      const upper = fieldName.toUpperCase();
      if (upper.includes("DATE")) return "date";
      return "text";
    }

    function fieldId(fieldName, index) {
      return (
        "field_" +
        index +
        "_" +
        fieldName
          .toString()
          .replace(/[^a-zA-Z0-9]+/g, "_")
      );
    }

    function showMessage(text, type) {
      messageEl.textContent = text || "";
      messageEl.className = type ? type : "";
    }

    function setEditIndicator(index) {
      if (index === null || index === undefined) {
        editIndicatorEl.style.display = "none";
        editIndicatorEl.textContent = "";
        saveRowBtn.textContent = "Save row";
        cancelEditBtn.style.display = "none";
        return;
      }
      editIndicatorEl.style.display = "inline-flex";
      editIndicatorEl.textContent = "Editing row #" + (index + 1);
      saveRowBtn.textContent = "Update row";
      cancelEditBtn.style.display = "inline-flex";
    }

    function clearForm() {
      Array.from(formEl.elements).forEach(el => {
        if (el.tagName === "INPUT") {
          el.value = "";
        }
      });
      editIndex = null;
      setEditIndicator(null);
      showMessage("", "");
    }

    function collectRowData() {
      if (!currentSheet) return null;
      const fields = sheetsConfig[currentSheet] || [];
      const row = {};
      let hasAnyValue = false;

      fields.forEach((fieldName, index) => {
        const id = fieldId(fieldName, index);
        const input = document.getElementById(id);
        const rawValue = input && input.value != null ? input.value : "";
        const value = typeof rawValue === "string" ? rawValue.trim() : rawValue;
        if (value !== "") {
          hasAnyValue = true;
        }
        row[fieldName] = value;
      });

      return { row, hasAnyValue };
    }

    function populateFormFromRow(row) {
      if (!currentSheet || !row) return;
      const fields = sheetsConfig[currentSheet] || [];
      fields.forEach((fieldName, index) => {
        const id = fieldId(fieldName, index);
        const input = document.getElementById(id);
        if (input) {
          input.value = row[fieldName] ?? "";
        }
      });
    }

    // Local storage

    function saveToLocalStorage() {
      try {
        const payload = JSON.stringify(dataStore);
        window.localStorage.setItem(LOCAL_STORAGE_KEY, payload);
      } catch (err) {
        console.warn("Failed to save to localStorage:", err);
      }
    }

    function loadFromLocalStorage() {
      try {
        const raw = window.localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        Object.keys(sheetsConfig).forEach(sheetName => {
          if (Array.isArray(parsed[sheetName])) {
            dataStore[sheetName] = parsed[sheetName];
          }
        });
      } catch (err) {
        console.warn("Failed to load from localStorage:", err);
      }
    }

    // Sheet list

    function renderSheetList() {
      const allSheetNames = Object.keys(sheetsConfig);
      sheetsCountEl.textContent = allSheetNames.length + " sheets";

      const filtered = allSheetNames.filter(name =>
        name.toLowerCase().includes(sheetSearchQuery.toLowerCase())
      );

      sheetListEl.innerHTML = "";
      filtered.forEach(name => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "sheet-btn" + (name === currentSheet ? " active" : "");
        const spanName = document.createElement("span");
        spanName.className = "name";
        spanName.textContent = name;
        const spanCount = document.createElement("span");
        spanCount.className = "fields-count";
        spanCount.textContent =
          (sheetsConfig[name] ? sheetsConfig[name].length : 0) + " fields";
        btn.appendChild(spanName);
        btn.appendChild(spanCount);
        btn.addEventListener("click", () => selectSheet(name));
        li.appendChild(btn);
        sheetListEl.appendChild(li);
      });

      if (!filtered.length) {
        const li = document.createElement("li");
        li.style.fontSize = "12px";
        li.style.color = "#9ca3af";
        li.textContent = "No sheets match your search.";
        sheetListEl.appendChild(li);
      }
    }

    function selectSheet(name) {
      currentSheet = name;
      editIndex = null;
      setEditIndicator(null);
      rowSearchQuery = "";
      rowSearchEl.value = "";
      currentPage = 1;
      showMessage("", "");
      renderSheetList();
      renderForm();
      renderSheetHeaderSummary();
      renderTable();
    }

    function renderSheetHeaderSummary() {
      if (!currentSheet) {
        sheetTitleEl.textContent = "Select a sheet from the left sidebar";
        sheetSubtitleEl.textContent =
          "Sheet fields and names are automatically generated from your Excel file.";
        fieldsCountTagEl.textContent = "0 fields";
        rowsCountTagEl.textContent = "0 rows";
        rowStatsEl.textContent = "";
        return;
      }
      const fields = sheetsConfig[currentSheet] || [];
      const rows = dataStore[currentSheet] || [];
      sheetTitleEl.textContent = currentSheet;
      sheetSubtitleEl.textContent =
        "This sheet has " +
        fields.length +
        " fields. Use the form to add or edit rows.";
      fieldsCountTagEl.textContent = fields.length + " fields";
      rowsCountTagEl.textContent = rows.length + " rows total";
      rowStatsEl.textContent = "Total rows: " + rows.length;
    }

    // Form

    function renderForm() {
      formEl.innerHTML = "";
      if (!currentSheet) return;

      const fields = sheetsConfig[currentSheet] || [];
      fields.forEach((fieldName, index) => {
        const group = document.createElement("div");
        group.className = "form-group";

        const label = document.createElement("label");
        label.textContent = fieldName;
        const input = document.createElement("input");
        input.type = guessInputType(fieldName);
        input.id = fieldId(fieldName, index);
        input.name = input.id;

        group.appendChild(label);
        group.appendChild(input);
        formEl.appendChild(group);
      });
    }

    // Table & pagination

    function getFilteredRows() {
      if (!currentSheet) return [];
      const rows = dataStore[currentSheet] || [];
      if (!rowSearchQuery.trim()) return rows;

      const query = rowSearchQuery.toLowerCase();
      const fields = sheetsConfig[currentSheet] || [];
      return rows.filter(row =>
        fields.some(fieldName => {
          const value = row[fieldName];
          if (value == null) return false;
          return String(value).toLowerCase().includes(query);
        })
      );
    }

    function renderPagination(totalRows, visibleRows, filteredRows) {
      if (!currentSheet) {
        paginationEl.innerHTML = "";
        return;
      }

      const total = filteredRows.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;

      const startIndex = (currentPage - 1) * pageSize + 1;
      const endIndex = Math.min(currentPage * pageSize, total);

      const infoText =
        "Showing " +
        (total ? startIndex + "â€“" + endIndex : "0") +
        " of " +
        total +
        " rows" +
        (rowSearchQuery.trim() ? " (filtered)" : "");

      const container = document.createElement("div");
      container.className = "pagination";

      const infoSpan = document.createElement("div");
      infoSpan.textContent = infoText;
      container.appendChild(infoSpan);

      const controls = document.createElement("div");
      controls.className = "pagination-controls";

      const prevBtn = document.createElement("button");
      prevBtn.type = "button";
      prevBtn.className = "pagination-btn";
      prevBtn.textContent = "Prev";
      prevBtn.disabled = currentPage <= 1;
      prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage -= 1;
          renderTable();
        }
      });

      const pageInfo = document.createElement("span");
      pageInfo.textContent = "Page " + currentPage + " / " + totalPages;

      const nextBtn = document.createElement("button");
      nextBtn.type = "button";
      nextBtn.className = "pagination-btn";
      nextBtn.textContent = "Next";
      nextBtn.disabled = currentPage >= totalPages;
      nextBtn.addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage += 1;
          renderTable();
        }
      });

      controls.appendChild(prevBtn);
      controls.appendChild(pageInfo);
      controls.appendChild(nextBtn);

      container.appendChild(controls);
      paginationEl.innerHTML = "";
      paginationEl.appendChild(container);
    }

    function renderTable() {
      tableEl.innerHTML = "";
      noDataMsgEl.textContent = "";
      paginationEl.innerHTML = "";

      if (!currentSheet) return;

      const fields = sheetsConfig[currentSheet] || [];
      const allRows = dataStore[currentSheet] || [];
      const filteredRows = getFilteredRows();

      const total = allRows.length;

      rowsCountTagEl.textContent = total + " rows total";
      if (rowSearchQuery.trim()) {
        rowStatsEl.textContent =
          "Filtered rows: " + filteredRows.length + " of " + total;
      } else {
        rowStatsEl.textContent = "Total rows: " + total;
      }

      if (!fields.length) {
        noDataMsgEl.textContent =
          "No fields are defined for this sheet in the code.";
        return;
      }

      if (!filteredRows.length) {
        if (total === 0) {
          noDataMsgEl.textContent =
            "No data entered for this sheet yet. Add a row using the form above.";
        } else {
          noDataMsgEl.textContent =
            "No rows match your search. Clear the search to see all rows.";
        }
        return;
      }

      const totalPages = Math.max(1, Math.ceil(filteredRows.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * pageSize;
      const end = Math.min(start + pageSize, filteredRows.length);
      const pageRows = filteredRows.slice(start, end);

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      fields.forEach(fieldName => {
        const th = document.createElement("th");
        th.textContent = fieldName;
        headerRow.appendChild(th);
      });

      const actionsTh = document.createElement("th");
      actionsTh.textContent = "Actions";
      headerRow.appendChild(actionsTh);

      thead.appendChild(headerRow);
      tableEl.appendChild(thead);

      const tbody = document.createElement("tbody");
      pageRows.forEach(row => {
        const realIndex = allRows.indexOf(row);
        const tr = document.createElement("tr");

        fields.forEach(fieldName => {
          const td = document.createElement("td");
          const v = row[fieldName];
          td.textContent = v == null ? "" : String(v);
          tr.appendChild(td);
        });

        const actionsTd = document.createElement("td");
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "table-actions";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "table-btn table-btn-edit";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          startEditRow(realIndex);
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "table-btn table-btn-delete";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => {
          deleteRow(realIndex);
        });

        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        actionsTd.appendChild(actionsDiv);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
      });

      tableEl.appendChild(tbody);

      renderPagination(total, pageRows.length, filteredRows);
    }

    function startEditRow(index) {
      if (!currentSheet) return;
      const rows = dataStore[currentSheet] || [];
      if (index < 0 || index >= rows.length) return;
      editIndex = index;
      populateFormFromRow(rows[index]);
      setEditIndicator(index);
      showMessage(
        "You are editing an existing row. Update fields and click \"Update row\".",
        "success"
      );
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteRow(index) {
      if (!currentSheet) return;
      const rows = dataStore[currentSheet] || [];
      if (index < 0 || index >= rows.length) return;

      const confirmed = window.confirm("Delete row #" + (index + 1) + " ?");
      if (!confirmed) return;

      rows.splice(index, 1);
      if (editIndex === index) {
        clearForm();
      } else if (editIndex !== null && index < editIndex) {
        editIndex -= 1;
      }
      saveToLocalStorage();
      renderSheetHeaderSummary();
      renderTable();
      showMessage("Row deleted.", "success");
    }

    // Actions

    function handleSaveRow() {
      if (!currentSheet) {
        showMessage("Please select a sheet first.", "error");
        return;
      }

      const fields = sheetsConfig[currentSheet] || [];
      if (!fields.length) {
        showMessage("No fields defined for this sheet in the code.", "error");
        return;
      }

      const result = collectRowData();
      if (!result) {
        showMessage("Unexpected error reading form fields.", "error");
        return;
      }

      const { row, hasAnyValue } = result;
      if (!hasAnyValue) {
        showMessage("Please fill at least one field before saving.", "error");
        return;
      }

      const rows = dataStore[currentSheet];

      if (editIndex === null || editIndex === undefined) {
        rows.push(row);
        showMessage("Row saved successfully.", "success");
      } else {
        rows[editIndex] = row;
        showMessage("Row updated successfully.", "success");
      }

      clearForm();
      saveToLocalStorage();
      renderSheetHeaderSummary();
      renderTable();
    }

    function handleExportJson() {
      try {
        const blob = new Blob([JSON.stringify(dataStore, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "sheets-data.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage("Data exported as JSON.", "success");
      } catch (err) {
        console.error(err);
        showMessage("Error exporting JSON.", "error");
      }
    }

    function handleImportJson(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const imported = JSON.parse(e.target.result);

          let importedSheetsCount = 0;
          Object.keys(sheetsConfig).forEach(sheetName => {
            if (Array.isArray(imported[sheetName])) {
              dataStore[sheetName] = imported[sheetName];
              importedSheetsCount += 1;
            }
          });

          saveToLocalStorage();
          renderSheetHeaderSummary();
          renderTable();
          showMessage(
            "Data imported from JSON for " +
              importedSheetsCount +
              " sheet(s).",
            "success"
          );
        } catch (err) {
          console.error(err);
          showMessage("Error reading JSON file.", "error");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file);
    }

    // Event bindings

    saveRowBtn.addEventListener("click", handleSaveRow);
    clearFormBtn.addEventListener("click", clearForm);
    cancelEditBtn.addEventListener("click", () => {
      clearForm();
      showMessage("Edit cancelled.", "success");
    });

    exportJsonBtn.addEventListener("click", handleExportJson);
    importJsonInput.addEventListener("change", handleImportJson);

    rowSearchEl.addEventListener("input", e => {
      rowSearchQuery = e.target.value || "";
      currentPage = 1;
      renderTable();
    });

    sheetSearchEl.addEventListener("input", e => {
      sheetSearchQuery = e.target.value || "";
      renderSheetList();
    });

    pageSizeSelectEl.addEventListener("change", e => {
      pageSize = parseInt(e.target.value, 10) || 50;
      currentPage = 1;
      renderTable();
    });

    // Initial load

    window.addEventListener("load", () => {
      loadFromLocalStorage();
      renderSheetList();
      const first = Object.keys(sheetsConfig)[0];
      if (first) {
        selectSheet(first);
      } else {
        renderSheetHeaderSummary();
      }
    });
  </script>
</body>
</html>
